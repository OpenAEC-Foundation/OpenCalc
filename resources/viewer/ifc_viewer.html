<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenCalc IFC Viewer</title>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #0f172a;
        }

        #container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #viewer {
            width: 100%;
            height: 100%;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #fff;
            z-index: 100;
        }

        #loading.hidden {
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #toolbar {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 5px;
            z-index: 50;
        }

        .tool-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.95);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .tool-btn:hover {
            background: #fff;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .tool-btn.active {
            background: #3b82f6;
            color: white;
        }

        #info-panel {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.98);
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 12px;
            max-width: 300px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            z-index: 50;
        }

        #info-panel.hidden {
            display: none;
        }

        #info-panel h4 {
            margin-bottom: 8px;
            color: #3b82f6;
        }

        #info-panel table {
            width: 100%;
        }

        #info-panel td {
            padding: 2px 0;
        }

        #info-panel td:first-child {
            color: #64748b;
            padding-right: 10px;
        }

        #drop-zone {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #64748b;
            padding: 60px;
            border: 3px dashed #334155;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.02);
        }

        #drop-zone.hidden {
            display: none;
        }

        #drop-zone h2 {
            color: #94a3b8;
            margin-bottom: 10px;
        }

        #drop-zone p {
            color: #64748b;
        }

        .drag-over #drop-zone {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="viewer"></div>

        <div id="loading" class="hidden">
            <div class="spinner"></div>
            <p>IFC model laden...</p>
        </div>

        <div id="drop-zone">
            <h2>IFC Viewer</h2>
            <p>Sleep een IFC bestand hierheen<br>of gebruik de knop om te openen</p>
        </div>

        <div id="toolbar" class="hidden">
            <button class="tool-btn" id="btn-fit" title="Passend maken">&#128306;</button>
            <button class="tool-btn" id="btn-ortho" title="Orthografisch/Perspectief">&#128208;</button>
            <button class="tool-btn" id="btn-section" title="Doorsnede">&#9986;</button>
        </div>

        <div id="info-panel" class="hidden">
            <h4>Element Info</h4>
            <table id="info-table">
                <tr><td>Type:</td><td id="info-type">-</td></tr>
                <tr><td>Naam:</td><td id="info-name">-</td></tr>
                <tr><td>GlobalId:</td><td id="info-guid">-</td></tr>
            </table>
        </div>
    </div>

    <!-- Import maps voor ES modules -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/examples/jsm/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "web-ifc": "https://unpkg.com/web-ifc@0.0.57/web-ifc-api.js",
            "@thatopen/components": "https://unpkg.com/@thatopen/components@2.3.0/dist/index.min.js",
            "@thatopen/fragments": "https://unpkg.com/@thatopen/fragments@2.2.0/dist/index.min.js"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import * as OBC from '@thatopen/components';

        // Qt bridge
        let qt = null;

        // Globale variabelen
        let components;
        let world;
        let fragments;
        let ifcLoader;
        let currentModel = null;
        let pendingLoad = null;

        // DOM elementen
        const container = document.getElementById('viewer');
        const loadingEl = document.getElementById('loading');
        const dropZone = document.getElementById('drop-zone');
        const toolbar = document.getElementById('toolbar');
        const infoPanel = document.getElementById('info-panel');

        // Initialiseer Qt WebChannel
        function initQtBridge() {
            if (typeof QWebChannel !== 'undefined') {
                new QWebChannel(qt.webChannelTransport, function(channel) {
                    qt = channel.objects.qt;
                    console.log('Qt bridge connected');
                    if (qt && qt.onViewerReady) {
                        qt.onViewerReady();
                    }
                });
            }
        }

        // Initialiseer de viewer
        async function init() {
            try {
                // Components setup
                components = new OBC.Components();

                // Maak wereld aan
                const worlds = components.get(OBC.Worlds);
                world = worlds.create();

                // Scene setup
                world.scene = new OBC.SimpleScene(components);
                world.scene.setup();
                world.scene.three.background = new THREE.Color(0x0f172a);

                // Renderer setup
                world.renderer = new OBC.SimpleRenderer(components, container);

                // Camera setup
                world.camera = new OBC.SimpleCamera(components);
                world.camera.controls.setLookAt(15, 15, 15, 0, 0, 0);

                // Grids
                const grids = components.get(OBC.Grids);
                grids.create(world);

                // Fragments manager
                fragments = components.get(OBC.FragmentsManager);

                // IFC loader setup
                ifcLoader = components.get(OBC.IfcLoader);
                await ifcLoader.setup();

                // Start renderen
                components.init();

                // Highlighter voor selectie
                const highlighter = components.get(OBC.Highlighter);
                highlighter.setup({ world });

                highlighter.events.select.onHighlight.add((fragmentMap) => {
                    showElementInfo(fragmentMap);
                });

                highlighter.events.select.onClear.add(() => {
                    infoPanel.classList.add('hidden');
                });

                // Event listeners
                setupEventListeners();

                // Resize observer voor container
                const resizeObserver = new ResizeObserver(() => {
                    if (world && world.renderer) {
                        world.renderer.resize();
                    }
                });
                resizeObserver.observe(container);

                console.log('IFC Viewer initialized');

                // Init Qt bridge
                initQtBridge();

                // Laad pending model als aanwezig
                if (pendingLoad) {
                    const { data, filename } = pendingLoad;
                    pendingLoad = null;
                    await loadIFC(data, filename);
                }

            } catch (error) {
                console.error('Init error:', error);
                dropZone.innerHTML = '<h2>Fout</h2><p>' + error.message + '</p>';
            }
        }

        // Laad IFC bestand
        async function loadIFC(buffer, filename) {
            loadingEl.classList.remove('hidden');
            dropZone.classList.add('hidden');

            try {
                // Verwijder bestaand model
                if (currentModel) {
                    fragments.dispose();
                }

                // Laad nieuw model
                const model = await ifcLoader.load(buffer);
                currentModel = model;

                // Forceer resize en render update
                if (world && world.renderer) {
                    world.renderer.resize();
                }

                // Pas camera aan
                setTimeout(() => {
                    if (currentModel && world && world.camera) {
                        world.camera.controls.fitToSphere(currentModel, true);
                    }
                }, 100);

                toolbar.classList.remove('hidden');
                loadingEl.classList.add('hidden');

                console.log('Model loaded:', filename);

                // Notify Qt
                if (qt && qt.onModelLoaded) {
                    qt.onModelLoaded(filename);
                }
            } catch (error) {
                console.error('Load error:', error);
                loadingEl.classList.add('hidden');
                dropZone.classList.remove('hidden');
                dropZone.innerHTML = '<h2>Laad fout</h2><p>' + error.message + '</p>';
            }
        }

        // Toon element info
        function showElementInfo(fragmentMap) {
            for (const [fragId, expressIDs] of fragmentMap) {
                const fragment = fragments.list.get(fragId);
                if (fragment && expressIDs.size > 0) {
                    const expressID = Array.from(expressIDs)[0];
                    document.getElementById('info-type').textContent = fragment.mesh.name || 'Onbekend';
                    document.getElementById('info-name').textContent = 'Element ' + expressID;
                    document.getElementById('info-guid').textContent = fragId.substring(0, 8) + '...';
                    infoPanel.classList.remove('hidden');
                    break;
                }
            }
        }

        // Event listeners
        function setupEventListeners() {
            // Drag & drop
            document.body.addEventListener('dragover', (e) => {
                e.preventDefault();
                document.body.classList.add('drag-over');
            });

            document.body.addEventListener('dragleave', () => {
                document.body.classList.remove('drag-over');
            });

            document.body.addEventListener('drop', async (e) => {
                e.preventDefault();
                document.body.classList.remove('drag-over');

                const file = e.dataTransfer.files[0];
                if (file && file.name.toLowerCase().endsWith('.ifc')) {
                    const buffer = await file.arrayBuffer();
                    loadIFC(new Uint8Array(buffer), file.name);
                }
            });

            // Toolbar buttons
            document.getElementById('btn-fit').addEventListener('click', () => {
                if (currentModel && world && world.camera) {
                    world.camera.controls.fitToSphere(currentModel, true);
                }
            });

            document.getElementById('btn-ortho').addEventListener('click', (e) => {
                const btn = e.currentTarget;
                btn.classList.toggle('active');
            });

            // Window resize
            window.addEventListener('resize', () => {
                if (world && world.renderer) {
                    world.renderer.resize();
                }
            });
        }

        // API voor Qt integratie
        window.loadIFCFile = async function(filePath) {
            try {
                const response = await fetch(filePath);
                const buffer = await response.arrayBuffer();
                const filename = filePath.split('/').pop();
                await loadIFC(new Uint8Array(buffer), filename);
            } catch (error) {
                console.error('Failed to load:', error);
            }
        };

        window.loadIFCBuffer = async function(base64Data, filename) {
            try {
                const binaryString = atob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }

                // Wacht tot viewer klaar is
                if (!components || !ifcLoader) {
                    console.log('Viewer not ready, queuing load...');
                    pendingLoad = { data: bytes, filename: filename };
                    return;
                }

                await loadIFC(bytes, filename);
            } catch (error) {
                console.error('Failed to load buffer:', error);
            }
        };

        window.fitView = function() {
            if (currentModel && world && world.camera) {
                world.camera.controls.fitToSphere(currentModel, true);
            }
        };

        window.setView = function(type) {
            if (!world || !world.camera) return;
            const views = {
                top: [0, 50, 0.1],
                front: [0, 10, 50],
                right: [50, 10, 0],
                iso: [30, 30, 30]
            };
            if (views[type]) {
                const [x, y, z] = views[type];
                world.camera.controls.setLookAt(x, y, z, 0, 0, 0, true);
            }
        };

        // Start
        init();
    </script>
</body>
</html>